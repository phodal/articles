# 遗留系统重构


## 重构分类

### 分层架构重构

在不改变业务逻辑的情况下，根据单一职责和依赖倒置原则的思想：

 - 对系统进行模块拆分与合并，以明确职责降低耦合度
 - 对包进行重新规划，划分包之间的边界，减少代码间的耦合
 - 

### 模式重构

对于特定代码坏味道产生的问题，通过结合设计模式来提升可读性：

 - 使用注册器模式优化 if 条件语句
 - 使用工厂模式统一管理对象的创建
 - 使用策略模式降低复杂度

等


### 模型重构

在包含测试的情况下，通过识别和发现模型的行为，将行为聚合到模型中：

### 微重构

对于一些小的代码坏味道，可以通过 IDE 重构来快速改善即有代码，而不会影响到业务功能。如：

 - 复杂条件语句的提取
 - 使用参数对象重构参数过多


## 分层架构重构

 - 按职责重新命名和划分 module
 - 根据技术、业务划分包，形成上下文边界，防止代码越界
 - 通过输出分层原则、团队赋能、接通对齐，统一内部对于分层架构的理解

## 模型重构

### domain 重构

1. static 方法识别。static 方法大多与类的职责无关，除了创建类之外（1. 移出；2. 转为实例方法）
2. 从领域模型中剥离复杂对象的创建过程（基本策略： 1. 继承 & 策略模式；2. 工厂 -> 普通工厂）
3. 类职责识别，与类职责无关的类（1. 移出）
4. domain 相关的 util，common，base 梳理（1. 转为对象实例方法 2. 按职责重命名 3. 拆分 util）
5. 业务流程梳理代码，完善领域逻辑

#### 提取工厂

1. static 方法识别。static 方法大多与类的职责无关，除了创建类之外（1. 移出；2. 转为实例方法）
2. 从领域模型中剥离复杂对象的创建过程（基本策略： 1. 继承 & 策略模式；2. 工厂 -> 普通工厂）
3. 类职责识别，与类职责无关的类（1. 移出）
4. domain 相关的 util，common，base 梳理（1. 转为对象实例方法 2. 按职责重命名 3. 拆分 util）
5. 业务流程梳理代码，完善领域逻辑

#### 剥离

重构手法：

1. 成员变量提取为参数（按调用层级往上提取）
2. 函数参数提供为参数对象
3. 解除内部依赖：
   3.1 static 化子方法 
   3.2 提取 helper 方法
4. 将方法转为静态方法
5. 移动方法到新对象
6. 复制、更新成员变量、静态变量等
7. 将方法转为 Instance method
8. 将函数参数转为成员变量
9. 重复上述步骤
10. 去除无用的静态变量

## 公共代码重构

### 技术模块重构

1. 根据 util 中的方法的职责，进行拆分。如 PropertyUtil ，包含了 converter,  database，domain 三个不同部分的代码。
2. 根据职责重新命名类，避免出现上帝工具类。如 StringUtils -> SafeTypeHelper
3. 将技术、业务模块专用的 util 内聚到技术、业务包内部，以避免增加模块间的耦合度。

#### 重构技巧：

1. 将函数转为静态方法，以解除对外的依赖（可选）
2. 将与函数职责无关的部分提取为函数的参数
3. 将函数的参数提取为参数对象
4. 将函数移到参数对象中
5. 重复 1 / 2 ~ 5 步
6. 内联 util 调用方






